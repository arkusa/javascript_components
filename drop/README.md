# Drop

javascript原生掉落动画(web / h5)

主要有2种模式

- **缓动曲线(数学模型)**

- **运动模型**

他们的区别在于

- **缓动曲线**是一个从起点到终点的过程

- **运动模型**在运动到终点后, 还会有一些附加的运动

  比如

  - x轴的匀减速运动
  - y轴的回弹
  - 或者是2者的复合运动

一般来说**缓动曲线**足够满足我们的应用场景了

> 实际上，开发这个Drop也是因为实际的需求中用到了掉落动画(添加购物车操作...), 就想着自己实现一下

在介绍API，我希望你对**缓动函数**有所了解

事实上，如果你了解**缓动函数**的话, 这种**掉落动画**是一个很简单的东西, 你甚至不需要去找一个**lib**来帮助实现

可能不到10 min, 你就能实现满足**UE**需求的动画

---

## 缓动函数

```javascript
f(x) = x;
function linear(t, b, c, d) {
  return c * t / d + b;
}
```

我第一次去了解**缓动函数**的时候看到上面的代码，我人都坏了.

`f(x)=x`怎么映射到`function linear`的呀...

直到我看到[如何使用Tween.js各类原生动画运动缓动算法](https://www.zhangxinxu.com/wordpress/2016/12/how-use-tween-js-animation-easing/), 这上面有注释, 鑫旭大佬真是好人!!!

```javascript
/*
 * t: current time（当前时间）；
 * b: beginning value（初始值）；
 * c: change in value（变化量）；
 * d: duration（持续时间）。
*/
```

实际上缓动函数就是将当前时间和总时间的比, 映射为当前位移和总位移的比

```
(current time - 0) / duration = change in value / (current offset - init offset)
t / d = c / f(s) - b
f(t / d) = t / d * c + b
```

所以我们每次只需要计算在`[0, 1]`区间内`t / b`的值就可以计算出当前的位移`f(t / d)`

`f(x) = x`, 这里的x 指的是 t / b的

`f(x) = x`的缓动函数就是`const linear => (t, b , c, d) => t / d * c + b`

`f(x) = x^2`的缓动函数就是`const easeIn = (t, b, c, d) => Math.pow((t / d), 2) * c + b`, 也就是`const easeIn = (t, b, c, d) => (t /= d) * t * c + b`

---

## 抛物线运动

`Drop`这个类诞生就是为了实现抛物线运动的

任何运动都可以分解为x, y 上的2种运动模型, 找到这个模型，我们就完成了90%的内容

### 采用缓动函数实现

有了前面缓动函数的基础, 想来实现一个抛物线应该是很简单的事情,

x 方向 是 `function linear`

**这里我介绍一下如何找到y方向上的缓动函数**

### y方向的缓动函数

我们已知`f(x) = a * x * x + b * x + c`是抛物线的数学模型, 根据前面缓动函数的知识, 我们可以得到这个抛物线一定经过`(0, 0)`和`(1, 1)`2个点

所以我们能够得到

```
c = 0;
a + b = 1;
```

我们知道抛物线极值点的坐标是

```
x = (0 - b) / 2 * a
y = (4 * a * c - b * b) / 4 * a
```

这里我推荐用**纵坐标**来计算, 因为比较直观, 这个y 值 找 **UE** 要, 你可能还需要去除 **c (change value)**, 具体看情况

一般来说代入计算的y值都小于1，因为这是一个`[0, 1]`区间内的比率

或者可以固定抛物线向上运动的高度, 然后用这个高度去除**c (change value)**, 一般来说**UE**都会给你这个值，而不是给你一个固定的比

这时候我们就可以代入

```
// y = 1 / 2
a + b = 1
0 - b * b = 1 / 2 * 4 * a
```

这里要先求`b`, 因为`a`的值一定都是负/正的,不好区分到底用那个值

如果当前是向下运动，那么正方向为下，向上运动则是负方向,  `f(x) = a * x * x + b * x` 应该先小于0, 然后大于0

所以`a < 0`, 且根据极值点的横坐标`-b / 2a`应该在`(0, 1)`之前, 所以我们要取`< 0`的b值

根据`a + b = 1`在计算`a`, 这样我们就得到了`a b`的值，这时候我们就能完成缓动函数

```javascript
function parabola(t, b, c, d) {
  t /= d
  
  return (a1 * t * t + b1 * t) * c + b
}
```

### 运动模型

运动模型主要是根据运动学公式计算位移的，**实现起来比较繁琐, 只是作为一种补充, 一般情况下缓动函数就足够了**

运动模型的主要实现在于到达终点(这里需要分x, y)会继续运动，然后会计算每次运动的能量(速度)损失, 当**速度**和**加速度**小于一定的值后运动才会停止

#### X方向上的速度损失

如果不提供`V0`的话，会根据位移和时间计算`平均V0`且加速度为0, 然后当到达x 方向的终点时, 速度损失为0, 停止运动

---

如果提供`V0`的话, 这个`V0`要满足一定的条件(`V0 <= 2 * 平均V0 && V0 > 平均V0`), 不满足条件的话`V0 === 2 * 平均V0`

这和运动是否能够到达x方向上的终点，以及是否发生折返有关系

#### Y方向上的

如果指定小于0 的初速度, 那么会向相反的方向位移, 也就是向上抛(一般情况)

---

当第一次运动到Y轴上的终点时会记录一个最大瞬时速度

当速度小于这个最大瞬时速度 / 10的时候认为运动停止

根据API，可以配置回弹次数，动态计算每次损失的速度, 也可以配置一个百分比( 1 / 2 ) 每次损失当前速度的 1 / 2

### API

```javascript
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
| prop          | type            | default value                 | description                                                             |
+===============|=================|===============================|=========================================================================+
| duration      | Number(ms)      | 1000                          | 运动到终点的持续时间                                                    |
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
| start         | Object          | {}                            | 起始点的位置信息                                                        |
| start.x       | Number          | undefined                     | 起始点的x 位置                                                          |
| start.y       | Number          | undefined                     | 起始点的y 位置                                                          |
| start.opacity | Number          | undefined                     | 起始点的透明度                                                          |
| start.rotate  | Number          | undefined                     | 起始点的旋转角度                                                        |
| start.scale   | Number          | undefined                     | 起始点的缩放大小                                                        |
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
| end           | Object          | {}                            | 终点的位置信息/基本同start                                              |
| end.x         | Number          | undefined                     | ~                                                                       |
| end.y         | Number          | undefined                     | ~                                                                       |
| end.opacity   | Number          | undefined                     | ~                                                                       |
| end.rotate    | Number          | undefined                     | ~                                                                       |
| end.scale     | Number          | undefined                     | ~                                                                       |
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
| el            | String          | undefined                     | 掉落的Dom 字符串, 以innerHTML的方式插入到文档                           |
| container     | Element         | document.body                 | 插入el的父级元素                                                        |
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
| animationEnd  | Function        | (destory) => {}               | 动画结束后触发, 接收destory函数, 执行destory会销毁创造出来的el          |
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
| easingX       | Function        | (t,b,c,d)=>b+c*t/d            | x方向上的缓动曲线, 只有easingX和easingY同时配置的话才会开启缓动曲线模式 |
| easingY       | Function        | (t,b,c,d)=>b+c*t/d            | y方向上的缓动曲线, 只有easingX和easingY同时配置的话才会开启缓动曲线模式 |
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
| vx            | Number(px/s)    | (end.x-start.x)*1000/duration | x方向上的初速度, vx >= default value && vx <= 2 * default value         |
| vy            | Number(px/s)    | 0                             | y 方向上的初速度, 一般情况下 <0 表示了向上运动                          |
| reduceEnergy  | Number( (0,1) ) | 1 / 2                         | 每次掉落到y方向的终点位置时, 瞬时速度损失的比例                         |
| reboundCound  | Number          | undefined                     | 控制y方向的回弹次数, 根据这个次数动态计算 reduceEnergy的值              |
+---------------|-----------------|-------------------------------|-------------------------------------------------------------------------+
```

### Demo

TODO
